#! /usr/bin/env ruby

def debug(info)
  #puts "DEBUG: #{info.is_a?(String) ? info : info.inspect}"
end

ram_source = '/Volumes/RamDisk/sr'
hd_source = '/Users/chenronghua/workspace/scarecrow-rules' 

source = ARGV[0]
source = ram_source if source == 'ram'
source = hd_source if source == 'hd'

Dir.chdir(source)
debug "git repo: #{source}"

def readSHA(target, sha, type=nil)

  type = type || `git cat-file -t #{sha}`.chomp
  debug "target:#{target}, sha: #{sha}, type: #{type}"

  if type == 'commit'
    commit = `git cat-file -p #{sha}`
    tree = commit.split(/\s+/)[1]
    return readSHA(target, tree, 'tree')
  elsif type == 'tree'
    tree = `git ls-tree -r #{sha} #{target}`
    raise RuntimeError.new("no object found for #{target}") if tree.empty?
    # tree
    return tree if tree.split(/\n/).length > 1
    # blob
    info = tree.split(/\s+/)
    return readSHA(nil, info[2], info[1])
  elsif type == 'blob'
    return `git cat-file -p #{sha}`
  end
end


sha = ARGV[1]
target = ARGV[2]
times = (ARGV[3] || 1).to_i

start_time = Time.now.to_f

times.times do |i|
  readSHA(target, sha)
  puts i
end


end_time = Time.now.to_f

debug "finished in #{((end_time - start_time)*1000).to_i} ms"
